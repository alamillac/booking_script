parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"mnjM":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.loginFirstStep=e,exports.loginSecondStep=s,exports.signIn=t,exports.getAuthToken=n;const o="https://account.booking.com";function n(o){console.log("Getting token");const n=o.match(/\"op_token\":\"([^"]+)\"/),t=o.match(/\"client_id\":\"([^"]+)\"/);if(!n)throw new Error("Token not found!");if(!t)throw new Error("Client_id not found!");return{opToken:n[1],clientId:t[1]}}async function t(n,t){const{username:e,opToken:s,password:a,clientId:i}=n;let l={url:o+"/account/sign-in/login_name",data:{login_name:e,op_token:s},method:"POST"};console.log("Request: "+l.url);let c=await t(l);return l={url:o+"/account/sign-in/password",data:{login_name:e,password:a,client_id:i,state:"",code_challenge:"",code_challenge_method:"",op_token:s},method:"POST"},console.log("Request: "+l.url),(c=await t(l)).data}async function e(e,s){const{username:a,password:i,partialPhone:l}=e;console.log("Request: https://admin.booking.com");let c=await s.get("https://admin.booking.com"),r=c.data;const{opToken:u,clientId:d}=n(r);console.log("Init login");const p=await t({username:a,opToken:u,password:i,clientId:d},s),m=p.phones_info.sms,h=p.authorization_token,g=m.find(o=>-1!=o.masked.indexOf(l)).hash;console.log("Init sms verification");const k={url:o+"/account/send/2fa-pin",data:{type:"sms",authorization_token:h,phone_id:g,op_token:u},method:"POST"};console.log("Request: "+k.url),c=await s(k);return{smsRequired:!0,tokens:{opToken:u,authorizationToken:h}}}async function s(n,t){const{smsToken:e,authorizationToken:s,opToken:a}=n;let i={url:o+"/account/sign-in/2fa-pin",data:{type:"sms",authorization_token:s,second_factor:e,op_token:a},method:"POST"};console.log("Request: "+i.url);let l=await t(i);i={url:l.data.redirect_uri,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}},console.log("Request: "+i.url),l=await t(i),console.log("Getting session and token from home page");const c=l.request.path.split("?")[1].split("&").map(o=>{const n=o.split("=");return{key:n[0],val:n[1]}}).find(o=>"ses"==o.key);if(!c)throw new Error("Session not found in home page!");const r={session:c.val};return console.log("Tokens found"),{tokens:r}}
},{}],"jNpo":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchReservations=c,exports.getCardFromReservation=l;var e=require("./login"),a=t(require("cheerio"));function t(e){return e&&e.__esModule?e:{default:e}}const o="https://admin.booking.com";function r(e){return parseFloat(e.replace(/[^0-9.]/g,""))}function n(e){return e.replace(/[0-9.]/g,"")}async function c(e,a,t){const{dateFrom:r,dateTo:n,hotelAccountId:c}=e,l=e.typeOfDates||"arrival",s={url:`${o}/fresa/extranet/group/reservations/search_reservations?lang=xu&ses=${a}`,method:"POST",headers:{Accept:"application/json, text/plain, */*","content-type":"application/json"},data:{page:1,per_page:50,type_of_dates:l,date_from:r,date_to:n,only_pending_requests:!1,show_cancelled:!1,only_booking_suite:!1,engine_version:1,hotel_account_id:c}};return console.log("Request: "+s.url),(await t(s)).data}async function l(t,c,l,s){const{hotelId:i,reservationId:d}=t,{username:u,password:p}=c;let h={url:`${o}/hotel/hoteladmin/extranet_ng/manage/booking.html?res_id=${d}&hotel_id=${i}&lang=xu&ses=${l}`,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}};console.log("Request: "+h.url);let m=await s(h),g=m.data;const _=g.match(/href=\"(https:\/\/account.booking.com\/oauth2\/authorize[^"]+)\"/);if(!_)throw new Error("Reservation detail not found!");const x=_[1];console.log("Request: "+x),g=(m=await s.get(x)).data;const{opToken:b,clientId:f}=(0,e.getAuthToken)(g);h={url:(await(0,e.signIn)({username:u,opToken:b,password:p,clientId:f},s)).redirect_uri,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}},console.log("Request: "+h.url),g=(m=await s(h)).data;const v=a.default.load(g),y={reservationId:d,charged:0,availableBalance:0,currency:"",cardNumber:"",cardType:"",cardHolderName:"",expirationDate:"",CVC:""},q=g.match(/You've already charged\s+<span>([^<]+)<\/span>/);return q&&(y.charged=r(q[1])),v("table table tr").slice(1).each((e,a)=>{const t=v(a).find("td"),o=t.eq(0).text(),c=t.eq(1).text();switch(o){case"Available balance:":y.availableBalance=r(c),y.currency=n(c);break;case"Card type:":y.cardType=c;break;case"Card number:":y.cardNumber=c.split(" ").join("");break;case"Card holder's name:":y.cardHolderName=c;break;case"Expiration Date:":y.expirationDate=c.split(" ").join("");break;case"CVC Code:":y.CVC=c}}),0===y.availableBalance&&console.log(g),y}
},{"./login":"mnjM"}],"OGpm":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.listProperties=t;const e="https://admin.booking.com";async function t({hotelAccountId:t},o,s){const n={url:`${e}/fresa/extranet/group/home/list_properties?lang=xu&ses=${o}`,method:"POST",headers:{Accept:"application/json, text/plain, */*","content-type":"application/json"},data:{filters:'{"search_term":"","show_closed":1}',hotel_account_id:t,limit:30,offset:0,sort_by:'{"field_name":"property_id","ascending":false}'}};return console.log("Request: "+n.url),(await s(n)).data}
},{}],"Focm":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Booking=u;var e=require("./login"),r=require("./reservations"),s=require("./properties"),o=i(require("axios")),t=i(require("axios-cookiejar-support")),n=i(require("tough-cookie"));function i(e){return e&&e.__esModule?e:{default:e}}(0,t.default)(o.default);const a=new n.default.CookieJar;function u(t){const n={tokens:{}},i=o.default.create({jar:a,withCredentials:!0,timeout:1e4,headers:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",Accept:"*/*","content-type":"application/json","x-requested-with":"XMLHttpRequest",origin:"https://account.booking.com"}});return{login:async r=>{if(r&&r.smsToken){const s=Object.assign({},r,n.tokens),{tokens:o}=await(0,e.loginSecondStep)(s,i);return n.tokens=o,{smsRequired:!1}}const{smsRequired:s,tokens:o}=await(0,e.loginFirstStep)(t,i);return n.tokens=o,{smsRequired:s}},searchReservations:async e=>{if(!n.tokens.session)throw new Error("Login required");return(0,r.searchReservations)(e,n.tokens.session,i)},listProperties:async e=>{if(!n.tokens.session)throw new Error("Login required");return(0,s.listProperties)(e,n.tokens.session,i)},getCardFromReservation:async e=>{if(!n.tokens.session)throw new Error("Login required");return(0,r.getCardFromReservation)(e,t,n.tokens.session,i)}}}
},{"./login":"mnjM","./reservations":"jNpo","./properties":"OGpm"}]},{},["Focm"], null)
//# sourceMappingURL=/index.js.map