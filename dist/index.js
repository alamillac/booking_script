parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"mnjM":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.login=i,exports.signIn=n,exports.getAuthToken=o;const e="https://account.booking.com";function t(e){console.log("Getting session and token from home page");const t=e.split("?")[1].split("&").map(e=>{const t=e.split("=");return{key:t[0],val:t[1]}}).find(e=>"ses"==e.key);if(!t)throw new Error("Session not found in home page!");return console.log("Session found"),t.val}function o(e){console.log("Getting token");const t=e.match(/\"op_token\":\"([^"]+)\"/),o=e.match(/\"client_id\":\"([^"]+)\"/);if(!t)throw new Error("Token not found!");if(!o)throw new Error("Client_id not found!");return{opToken:t[1],clientId:o[1]}}async function n(t,o){const{username:n,opToken:s,password:a,clientId:i}=t;let r={url:e+"/account/sign-in/login_name",data:{login_name:n,op_token:s},method:"POST"};console.log("Request: "+r.url);let l=await o(r);return r={url:e+"/account/sign-in/password",data:{login_name:n,password:a,client_id:i,state:"",code_challenge:"",code_challenge_method:"",op_token:s},method:"POST"},console.log("Request: "+r.url),(l=await o(r)).data}async function s(s,a){const{username:i,password:r,partialPhone:l}=s;console.log("Request: https://admin.booking.com");let c=await a.get("https://admin.booking.com"),u=c.data;const{opToken:d,clientId:p}=o(u);console.log("Init login");const h=await n({username:i,opToken:d,password:r,clientId:p},a);if(void 0!==h.redirect_uri){const e={"content-type":a.defaults.headers["content-type"],"x-requested-with":a.defaults.headers["x-requested-with"]};delete a.defaults.headers["content-type"],delete a.defaults.headers["x-requested-with"];let o={url:h.redirect_uri,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",Referer:"https://account.booking.com/"},maxRedirects:0,validateStatus:function(e){return 302===e}};return console.log("Request: "+o.url),o={url:(c=await a(o)).headers.location,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",Referer:"https://account.booking.com/"},maxRedirects:0,validateStatus:function(e){return 302===e}},console.log("Request: "+o.url),o={url:"https://admin.booking.com"+(c=await a(o)).headers.location,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",Referer:"https://account.booking.com/"},maxRedirects:0},console.log("Request: "+o.url),c=await a(o),a.defaults.headers["content-type"]=e["content-type"],a.defaults.headers["x-requested-with"]=e["x-requested-with"],{smsRequired:!1,tokens:{session:t(c.request.path)}}}const m=h.phones_info.sms,g=h.authorization_token,f=m.find(e=>-1!=e.masked.indexOf(l)).hash;console.log("Init sms verification");const k={url:e+"/account/send/2fa-pin",data:{type:"sms",authorization_token:g,phone_id:f,op_token:d},method:"POST"};console.log("Request: "+k.url),c=await a(k);return{smsRequired:!0,tokens:{opToken:d,authorizationToken:g}}}async function a(o,n){const{smsToken:s,authorizationToken:a,opToken:i}=o;let r={url:e+"/account/sign-in/2fa-pin",data:{type:"sms",authorization_token:a,second_factor:s,op_token:i},method:"POST"};console.log("Request: "+r.url);let l=await n(r);return r={url:l.data.redirect_uri,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}},console.log("Request: "+r.url),{session:t((l=await n(r)).request.path)}}async function i(e,t,o){const{smsRequired:n,tokens:i}=await s(e,o);if(!n)return i;const r=await t();return i.smsToken=r,await a(i,o)}
},{}],"jNpo":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchReservations=s,exports.getCardFromReservation=l;var e=require("./login"),t=o(require("cheerio")),a=o(require("query-string"));function o(e){return e&&e.__esModule?e:{default:e}}const n="https://admin.booking.com";function r(e){return parseFloat(e.replace(/[^0-9.]/g,""))}function i(e){return e.replace(/[0-9.]/g,"")}function c(e){const t={};return e.find("input").each((e,a)=>{t[a.attribs.name]=a.attribs.value}),t}async function s(e,t,a){const{dateFrom:o,dateTo:r,hotelAccountId:i}=e,c=e.typeOfDates||"arrival",s={url:`${n}/fresa/extranet/group/reservations/search_reservations?lang=xu&ses=${t}`,method:"POST",headers:{Accept:"application/json, text/plain, */*","content-type":"application/json"},data:{page:1,per_page:50,type_of_dates:c,date_from:o,date_to:r,only_pending_requests:!1,show_cancelled:!1,only_booking_suite:!1,engine_version:1,hotel_account_id:i}};return console.log("Request: "+s.url),(await a(s)).data}async function l(o,s,l,d,p){const{hotelId:u,reservationId:h}=o,{username:m,password:_}=s;let f={url:`${n}/hotel/hoteladmin/extranet_ng/manage/booking.html?res_id=${h}&hotel_id=${u}&lang=xu&ses=${l}`,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}};console.log("Request: "+f.url);let g=await p(f),x=g.data;const q=x.match(/href=\"(https:\/\/account.booking.com\/oauth2\/authorize[^"]+)\"/);if(!q)throw new Error("Reservation detail not found!");const b=q[1];console.log("Request: "+b),x=(g=await p.get(b)).data;const{opToken:w,clientId:y}=(0,e.getAuthToken)(x);if(f={url:(await(0,e.signIn)({username:m,opToken:w,password:_,clientId:y},p)).redirect_uri,method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}},console.log("Request: "+f.url),(x=(g=await p(f)).data).includes("Please choose a verification method")){console.log("2FA required");const{partialPhone:e}=s,o="https://secure-admin.booking.com/2fa/";let n=t.default.load(x),r=n("form#select_phone_number"),i=r.attr("action"),l=c(r),u={dest:l.dest,check_pin_auth:l.check_pin_auth,message_type:"sms",ask_pin:"",phone_id:"",phone_id_call:"",phone_id_sms:""};r.find("option").each((t,a)=>{const o=n(a);if(o.text().includes(e)){const e=o.val();u.phone_id=e,u.phone_id_call=e,u.phone_id_sms=e}}),f={url:o+i,data:u,method:"POST",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","content-type":"application/x-www-form-urlencoded",Referer:o+g.request.path},transformRequest:[(e,t)=>(delete t.common["x-requested-with"],a.default.stringify(e))]},console.log("Request: "+f.url),x=(g=await p(f)).data,i=(r=(n=t.default.load(x))("form#enter_security_pin")).attr("action");const h=await d();l=c(r),f={url:o+i,data:u={ask_pin:h,hotel_id:l.hotel_id,ses:l.ses,account_id:l.account_id,dest:l.dest,pulse:0,pcip:"",from_pulse:"",check_pin_auth:l.check_pin_auth},method:"POST",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","content-type":"application/x-www-form-urlencoded",Referer:o+g.request.path},transformRequest:[(e,t)=>(delete t.common["x-requested-with"],a.default.stringify(e))]},console.log("Request: "+f.url),x=(g=await p(f)).data}const k=t.default.load(x),v={reservationId:h,charged:0,availableBalance:0,currency:"",cardNumber:"",cardType:"",cardHolderName:"",expirationDate:"",CVC:""},R=x.match(/You've already charged\s+<span>([^<]+)<\/span>/);return R&&(v.charged=r(R[1])),k("table table tr").slice(1).each((e,t)=>{const a=k(t).find("td"),o=a.eq(0).text(),n=a.eq(1).text();switch(o){case"Available balance:":v.availableBalance=r(n),v.currency=i(n);break;case"Card type:":v.cardType=n;break;case"Card number:":v.cardNumber=n.split(" ").join("");break;case"Card holder's name:":v.cardHolderName=n;break;case"Expiration Date:":v.expirationDate=n.split(" ").join("");break;case"CVC Code:":v.CVC=n}}),0===v.availableBalance&&console.warn("Posible error detected"),v}
},{"./login":"mnjM"}],"OGpm":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.listProperties=t;const e="https://admin.booking.com";async function t({hotelAccountId:t},o,s){const n={url:`${e}/fresa/extranet/group/home/list_properties?lang=xu&ses=${o}`,method:"POST",headers:{Accept:"application/json, text/plain, */*","content-type":"application/json"},data:{filters:'{"search_term":"","show_closed":1}',hotel_account_id:t,limit:30,offset:0,sort_by:'{"field_name":"property_id","ascending":false}'}};return console.log("Request: "+n.url),(await s(n)).data}
},{}],"Focm":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Booking=u;var e=require("./login"),s=require("./reservations"),o=require("./properties"),t=a(require("axios")),i=a(require("axios-cookiejar-support")),r=a(require("tough-cookie")),n=a(require("tough-cookie-file-store"));function a(e){return e&&e.__esModule?e:{default:e}}function u(i,a,u="/tmp/bookingCookie.json"){let c;c=u?new r.default.CookieJar(new n.default(u)):new r.default.CookieJar;const l={session:null},p=t.default.create({jar:c,withCredentials:!0,timeout:1e4,headers:{"User-Agent":"Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0",Accept:"*/*","content-type":"application/json","x-requested-with":"XMLHttpRequest",origin:"https://account.booking.com"}});async function f(){const{session:s}=await(0,e.login)(i,a,p);return s}return{searchReservations:async e=>(l.session||(l.session=await f()),(0,s.searchReservations)(e,l.session,p)),listProperties:async e=>(l.session||(l.session=await f()),(0,o.listProperties)(e,l.session,p)),getCardsFromReservations:async e=>{if(0==e.length)return[];l.session||(l.session=await f());const o=[];for(let t of e){const e=await(0,s.getCardFromReservation)(t,i,l.session,a,p);o.push(e)}return o}}}(0,i.default)(t.default);
},{"./login":"mnjM","./reservations":"jNpo","./properties":"OGpm"}]},{},["Focm"], null)
//# sourceMappingURL=/index.js.map